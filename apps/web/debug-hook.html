<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug useWeatherLocations Hook</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .step h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .info {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug useWeatherLocations Hook</h1>
        <p>This page simulates the exact behavior of the useWeatherLocations hook to identify console errors.</p>
        
        <div class="info">
            <strong>📋 Instructions:</strong> Open browser DevTools (F12) and watch the Console tab for any errors, network failures, or API issues.
        </div>
        
        <div class="step">
            <h3>Step 1: API Server Check<span id="api-status" class="status loading">Checking...</span></h3>
            <p>Testing if the API server is accessible...</p>
            <pre id="api-result"></pre>
            <button onclick="checkAPIServer()">Recheck API Server</button>
        </div>
        
        <div class="step">
            <h3>Step 2: Hook Initialization<span id="hook-status" class="status loading">Initializing...</span></h3>
            <p>Simulating useWeatherLocations hook initialization...</p>
            <pre id="hook-result"></pre>
            <button onclick="initializeHook()">Reinitialize Hook</button>
        </div>
        
        <div class="step">
            <h3>Step 3: Location Detection<span id="location-status" class="status loading">Detecting...</span></h3>
            <p>Testing browser geolocation and IP location fallback...</p>
            <pre id="location-result"></pre>
            <button onclick="detectLocation()">Retry Location Detection</button>
        </div>
        
        <div class="step">
            <h3>Step 4: Weather Data Fetch<span id="weather-status" class="status loading">Fetching...</span></h3>
            <p>Fetching weather data with detected location...</p>
            <pre id="weather-result"></pre>
            <button onclick="fetchWeatherData()">Retry Weather Fetch</button>
        </div>
        
        <div class="step">
            <h3>Step 5: Hook State Simulation<span id="state-status" class="status loading">Simulating...</span></h3>
            <p>Simulating the full hook state lifecycle...</p>
            <pre id="state-result"></pre>
            <button onclick="simulateHookState()">Run Full Simulation</button>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>Console Log Monitor:</h3>
            <button onclick="clearAllLogs()">Clear All Logs</button>
            <button onclick="runAllTests()">Run All Tests</button>
            <pre id="console-log"></pre>
        </div>
    </div>

    <script>
        // Global state
        let consoleLog = [];
        let currentUserLocation = null;
        let weatherData = null;
        let hookState = {
            loading: true,
            error: null,
            locations: [],
            lastFetch: null
        };
        
        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            consoleLog.push(logEntry);
            
            // Also log to browser console
            console.log(logEntry);
            
            // Update display
            updateConsoleDisplay();
        }
        
        function updateConsoleDisplay() {
            const consoleElement = document.getElementById('console-log');
            consoleElement.textContent = consoleLog.join('\n');
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        function setStepStatus(stepId, status, message) {
            const statusElement = document.getElementById(stepId + '-status');
            const resultElement = document.getElementById(stepId + '-result');
            
            statusElement.className = `status ${status}`;
            statusElement.textContent = message;
            
            if (resultElement) {
                resultElement.textContent = resultElement.textContent; // Trigger update
            }
        }
        
        function setStepResult(stepId, result) {
            const resultElement = document.getElementById(stepId + '-result');
            resultElement.textContent = typeof result === 'object' ? JSON.stringify(result, null, 2) : result;
        }
        
        // Step 1: API Server Check
        async function checkAPIServer() {
            log('Checking API server availability...', 'info');
            setStepStatus('api', 'loading', 'Checking...');
            
            try {
                const response = await fetch('http://localhost:4000/api/weather-locations?limit=1');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    setStepStatus('api', 'success', 'API Available');
                    setStepResult('api', `✅ API Server: ${response.status} ${response.statusText}\n✅ Response: ${JSON.stringify(data, null, 2)}`);
                    log('API server check passed', 'success');
                } else {
                    setStepStatus('api', 'error', 'API Error');
                    setStepResult('api', `❌ API Error: ${response.status} ${response.statusText}\n${JSON.stringify(data, null, 2)}`);
                    log(`API server error: ${response.status} ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                setStepStatus('api', 'error', 'Connection Failed');
                setStepResult('api', `❌ Connection Error: ${error.message}\n❌ This usually means the API server is not running\n❌ Expected: node dev-api-server.js running on port 4000`);
                log(`API server connection failed: ${error.message}`, 'error');
            }
        }
        
        // Step 2: Hook Initialization
        async function initializeHook() {
            log('Initializing useWeatherLocations hook simulation...', 'info');
            setStepStatus('hook', 'loading', 'Initializing...');
            
            try {
                // Simulate hook initialization
                hookState = {
                    loading: true,
                    error: null,
                    locations: [],
                    lastFetch: null
                };
                
                // Simulate the options that would be passed to the hook
                const options = {
                    userLocation: currentUserLocation,
                    radius: 50,
                    limit: 40
                };
                
                setStepStatus('hook', 'success', 'Initialized');
                setStepResult('hook', `✅ Hook State: ${JSON.stringify(hookState, null, 2)}\n✅ Options: ${JSON.stringify(options, null, 2)}`);
                log('Hook initialization completed', 'success');
            } catch (error) {
                setStepStatus('hook', 'error', 'Initialization Failed');
                setStepResult('hook', `❌ Initialization Error: ${error.message}`);
                log(`Hook initialization failed: ${error.message}`, 'error');
            }
        }
        
        // Step 3: Location Detection
        async function detectLocation() {
            log('Starting location detection...', 'info');
            setStepStatus('location', 'loading', 'Detecting...');
            
            let locationResults = [];
            
            // Test 1: Browser Geolocation
            try {
                const geolocation = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            });
                        },
                        (error) => {
                            reject(error);
                        },
                        { timeout: 10000, enableHighAccuracy: false }
                    );
                });
                
                locationResults.push(`✅ Geolocation: ${geolocation.lat}, ${geolocation.lng} (±${geolocation.accuracy}m)`);
                currentUserLocation = [geolocation.lat, geolocation.lng];
                log(`Geolocation success: ${geolocation.lat}, ${geolocation.lng}`, 'success');
            } catch (error) {
                locationResults.push(`❌ Geolocation Failed: ${error.message}`);
                log(`Geolocation failed: ${error.message}`, 'error');
            }
            
            // Test 2: IP Location Fallback
            try {
                const ipResponse = await fetch('https://ipapi.co/json/');
                const ipData = await ipResponse.json();
                
                if (ipData.latitude && ipData.longitude) {
                    locationResults.push(`✅ IP Location: ${ipData.latitude}, ${ipData.longitude} (${ipData.city}, ${ipData.region})`);
                    if (!currentUserLocation) {
                        currentUserLocation = [ipData.latitude, ipData.longitude];
                    }
                    log(`IP location success: ${ipData.city}, ${ipData.region}`, 'success');
                } else {
                    locationResults.push(`❌ IP Location: No coordinates returned`);
                    log(`IP location failed: No coordinates in response`, 'error');
                }
            } catch (error) {
                locationResults.push(`❌ IP Location Failed: ${error.message}`);
                log(`IP location failed: ${error.message}`, 'error');
            }
            
            // Test 3: Fallback Location
            if (!currentUserLocation) {
                currentUserLocation = [46.7296, -94.6859]; // Minnesota default
                locationResults.push(`⚠️ Using Fallback Location: ${currentUserLocation[0]}, ${currentUserLocation[1]} (Minnesota)`);
                log('Using fallback location (Minnesota)', 'warning');
            }
            
            const status = currentUserLocation ? 'success' : 'error';
            const message = currentUserLocation ? 'Location Detected' : 'Location Failed';
            
            setStepStatus('location', status, message);
            setStepResult('location', locationResults.join('\n'));
        }
        
        // Step 4: Weather Data Fetch
        async function fetchWeatherData() {
            log('Fetching weather data...', 'info');
            setStepStatus('weather', 'loading', 'Fetching...');
            
            try {
                hookState.loading = true;
                hookState.error = null;
                
                // Build query parameters (matching the hook logic)
                const params = new URLSearchParams({
                    limit: '40'
                });
                
                if (currentUserLocation) {
                    params.append('lat', currentUserLocation[0].toString());
                    params.append('lng', currentUserLocation[1].toString());
                    params.append('radius', '50');
                }
                
                // API URL (matching the hook logic)
                const apiUrl = `http://localhost:4000/api/weather-locations?${params}`;
                log(`API URL: ${apiUrl}`, 'info');
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch weather locations');
                }
                
                hookState.loading = false;
                hookState.locations = result.data;
                hookState.lastFetch = new Date();
                weatherData = result;
                
                setStepStatus('weather', 'success', 'Data Fetched');
                setStepResult('weather', `✅ Success: ${result.success}\n✅ Count: ${result.count}\n✅ Query Type: ${result.debug?.query_type}\n✅ Data Source: ${result.debug?.data_source}\n✅ Sample Location: ${result.data[0]?.name || 'None'}\n\n${JSON.stringify(result, null, 2).slice(0, 1000)}...`);
                log(`Weather data fetched successfully: ${result.count} locations`, 'success');
                
            } catch (error) {
                hookState.loading = false;
                hookState.error = error.message;
                
                setStepStatus('weather', 'error', 'Fetch Failed');
                setStepResult('weather', `❌ Error: ${error.message}\n❌ Hook State: ${JSON.stringify(hookState, null, 2)}`);
                log(`Weather data fetch failed: ${error.message}`, 'error');
            }
        }
        
        // Step 5: Hook State Simulation
        async function simulateHookState() {
            log('Simulating full hook state lifecycle...', 'info');
            setStepStatus('state', 'loading', 'Simulating...');
            
            try {
                // Simulate the full useWeatherLocations hook behavior
                const simulation = {
                    initialState: {
                        loading: true,
                        error: null,
                        locations: [],
                        lastFetch: null
                    },
                    options: {
                        userLocation: currentUserLocation,
                        radius: 50,
                        limit: 40
                    },
                    finalState: hookState,
                    computedValues: {
                        hasData: hookState.locations.length > 0,
                        isEmpty: !hookState.loading && hookState.locations.length === 0,
                        isStale: hookState.lastFetch && Date.now() - hookState.lastFetch.getTime() > 5 * 60 * 1000
                    }
                };
                
                setStepStatus('state', 'success', 'Simulation Complete');
                setStepResult('state', JSON.stringify(simulation, null, 2));
                log('Hook state simulation completed', 'success');
                
            } catch (error) {
                setStepStatus('state', 'error', 'Simulation Failed');
                setStepResult('state', `❌ Simulation Error: ${error.message}`);
                log(`Hook state simulation failed: ${error.message}`, 'error');
            }
        }
        
        // Utility functions
        function clearAllLogs() {
            consoleLog = [];
            updateConsoleDisplay();
            console.clear();
        }
        
        async function runAllTests() {
            log('=== Starting comprehensive test suite ===', 'info');
            
            await checkAPIServer();
            await initializeHook();
            await detectLocation();
            await fetchWeatherData();
            await simulateHookState();
            
            log('=== Test suite completed ===', 'info');
        }
        
        // Initialize page
        function init() {
            log('Debug page initialized', 'info');
            log(`Current URL: ${window.location.href}`, 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            
            // Auto-run tests after a short delay
            setTimeout(runAllTests, 1000);
        }
        
        // Global error handlers
        window.addEventListener('error', (event) => {
            log(`Global Error: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
            console.error('Global Error:', event);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`Unhandled Promise Rejection: ${event.reason}`, 'error');
            console.error('Unhandled Promise Rejection:', event);
        });
        
        // Initialize when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>