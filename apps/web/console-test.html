<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Log Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .loading {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Console Log Test for Weather API</h1>
        <p>This page tests the weather API and logs all results to the console.</p>
        
        <div id="status" class="status loading">
            Loading...
        </div>
        
        <div id="results">
            <h3>Results:</h3>
            <pre id="output"></pre>
        </div>
        
        <div>
            <h3>Manual Tests:</h3>
            <button onclick="testDirectAPI()">Test Direct API</button>
            <button onclick="testWithUserLocation()">Test With User Location</button>
            <button onclick="testIPLocation()">Test IP Location</button>
            <button onclick="testAllScenarios()">Test All Scenarios</button>
            <button onclick="clearOutput()">Clear Output</button>
        </div>
        
        <div>
            <h3>Browser Info:</h3>
            <pre id="browser-info"></pre>
        </div>
    </div>

    <script>
        // Global variables to track state
        let testResults = [];
        
        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = { timestamp, message, type };
            testResults.push(logEntry);
            
            // Log to browser console
            console.log(`[${timestamp}] ${message}`, type);
            
            // Update display
            updateDisplay();
        }
        
        function updateDisplay() {
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            
            // Update output
            output.textContent = testResults.map(r => 
                `[${r.timestamp}] ${r.type.toUpperCase()}: ${r.message}`
            ).join('\n');
            
            // Update status
            const hasErrors = testResults.some(r => r.type === 'error');
            const hasSuccess = testResults.some(r => r.type === 'success');
            
            if (hasErrors) {
                status.className = 'status error';
                status.textContent = 'Tests completed with errors - check console for details';
            } else if (hasSuccess) {
                status.className = 'status success';
                status.textContent = 'Tests completed successfully';
            } else {
                status.className = 'status loading';
                status.textContent = 'Running tests...';
            }
        }
        
        function clearOutput() {
            testResults = [];
            updateDisplay();
            console.clear();
        }
        
        // Test functions
        async function testDirectAPI() {
            log('Testing direct API call...', 'info');
            
            try {
                const response = await fetch('http://localhost:4000/api/weather-locations?limit=5');
                const data = await response.json();
                
                log(`API Response: ${response.status} ${response.statusText}`, 'success');
                log(`API Success: ${data.success}`, 'success');
                log(`Data Count: ${data.count}`, 'success');
                log(`Sample Location: ${data.data[0]?.name || 'None'}`, 'success');
                log(`Timestamp: ${data.timestamp}`, 'success');
                
                console.log('Full API Response:', data);
                
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                console.error('API Error:', error);
            }
        }
        
        async function testWithUserLocation() {
            log('Testing API with user location...', 'info');
            
            try {
                const params = new URLSearchParams({
                    lat: '46.7296',
                    lng: '-94.6859',
                    radius: '100',
                    limit: '10'
                });
                
                const response = await fetch(`http://localhost:4000/api/weather-locations?${params}`);
                const data = await response.json();
                
                log(`User Location Response: ${response.status}`, 'success');
                log(`User Location Success: ${data.success}`, 'success');
                log(`User Location Data Count: ${data.count}`, 'success');
                log(`Query Type: ${data.debug?.query_type || 'unknown'}`, 'success');
                
                console.log('User Location Response:', data);
                
            } catch (error) {
                log(`User Location Error: ${error.message}`, 'error');
                console.error('User Location Error:', error);
            }
        }
        
        async function testIPLocation() {
            log('Testing IP location service...', 'info');
            
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                log(`IP Location Response: ${response.status}`, 'success');
                log(`IP Location: ${data.latitude}, ${data.longitude}`, 'success');
                log(`IP City: ${data.city || 'unknown'}`, 'success');
                log(`IP Region: ${data.region || 'unknown'}`, 'success');
                
                console.log('IP Location Response:', data);
                
            } catch (error) {
                log(`IP Location Error: ${error.message}`, 'error');
                console.error('IP Location Error:', error);
            }
        }
        
        async function testGeolocation() {
            log('Testing browser geolocation...', 'info');
            
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    log('Geolocation not supported', 'error');
                    resolve(null);
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        log(`Geolocation: ${lat}, ${lng}`, 'success');
                        log(`Accuracy: ${position.coords.accuracy} meters`, 'success');
                        console.log('Geolocation Position:', position);
                        resolve([lat, lng]);
                    },
                    (error) => {
                        log(`Geolocation Error: ${error.message}`, 'error');
                        console.error('Geolocation Error:', error);
                        resolve(null);
                    },
                    { timeout: 10000, enableHighAccuracy: false }
                );
            });
        }
        
        async function testAllScenarios() {
            log('=== Starting comprehensive test ===', 'info');
            
            // Test 1: Direct API
            await testDirectAPI();
            
            // Test 2: User location
            await testWithUserLocation();
            
            // Test 3: IP location
            await testIPLocation();
            
            // Test 4: Geolocation
            await testGeolocation();
            
            // Test 5: Network conditions
            log('Testing network conditions...', 'info');
            const startTime = Date.now();
            try {
                await fetch('http://localhost:4000/api/weather-locations?limit=1');
                const endTime = Date.now();
                log(`Network latency: ${endTime - startTime}ms`, 'success');
            } catch (error) {
                log(`Network test failed: ${error.message}`, 'error');
            }
            
            log('=== All tests completed ===', 'info');
        }
        
        // Initialize page
        function init() {
            // Display browser info
            const browserInfo = document.getElementById('browser-info');
            browserInfo.textContent = `
User Agent: ${navigator.userAgent}
Language: ${navigator.language}
Online: ${navigator.onLine}
Geolocation: ${navigator.geolocation ? 'Available' : 'Not available'}
Current URL: ${window.location.href}
Protocol: ${window.location.protocol}
Host: ${window.location.host}
            `.trim();
            
            // Log initial state
            log('Page initialized', 'info');
            log(`Current URL: ${window.location.href}`, 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            
            // Auto-run basic tests
            setTimeout(testAllScenarios, 1000);
        }
        
        // Handle page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Global error handler
        window.addEventListener('error', (event) => {
            log(`Global Error: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
            console.error('Global Error:', event);
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            log(`Unhandled Promise Rejection: ${event.reason}`, 'error');
            console.error('Unhandled Promise Rejection:', event);
        });
    </script>
</body>
</html>